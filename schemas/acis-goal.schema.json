{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "acis-v2-goal.schema.json",
  "title": "ACIS v2 Goal Schema",
  "description": "Enhanced schema with multi-perspective discovery, behavioral TDD, and independently verifiable metrics",
  "type": "object",
  "required": ["id", "source", "detection", "target", "verification", "multi_perspective", "behavioral", "consensus"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier (e.g., 'WO63-CRIT-001-key-rotation')",
      "pattern": "^[A-Z0-9]+-[A-Z]+-[0-9]+-[a-z0-9-]+$"
    },
    "source": {
      "type": "object",
      "required": ["origin", "lens", "severity"],
      "properties": {
        "origin": {
          "type": "string",
          "enum": ["pr-review", "multi-agent-discovery", "manual", "acis-extraction"],
          "description": "How this goal was created"
        },
        "pr_number": { "type": "integer" },
        "wo_id": { "type": "string" },
        "lens": {
          "type": "string",
          "enum": [
            "security", "privacy", "performance", "maintainability",
            "accessibility", "architecture", "testing", "operations",
            "crash-resilience", "ux", "algorithm-elegance"
          ]
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low"]
        },
        "original_comment": { "type": "string" }
      }
    },
    "detection": {
      "type": "object",
      "required": ["primary_command", "verifiable_metrics"],
      "properties": {
        "primary_command": {
          "type": "string",
          "description": "Main detection command (must be a meaningful shell command)",
          "minLength": 5
        },
        "pattern": { "type": "string" },
        "search_paths": {
          "type": "array",
          "items": { "type": "string" }
        },
        "exclusions": {
          "type": "array",
          "items": { "type": "string" }
        },
        "verifiable_metrics": {
          "type": "array",
          "description": "Independently verifiable metrics - ALL agents must be able to verify",
          "items": {
            "type": "object",
            "required": ["metric_id", "name", "command", "expected_value", "tolerance"],
            "properties": {
              "metric_id": {
                "type": "string",
                "description": "Unique metric identifier (snake_case, minimum 3 chars)",
                "minLength": 3,
                "pattern": "^[a-z][a-z0-9_]*$"
              },
              "name": {
                "type": "string",
                "description": "Human-readable metric name",
                "minLength": 3
              },
              "command": {
                "type": "string",
                "description": "Shell command that outputs a single value",
                "minLength": 5
              },
              "parse_type": {
                "type": "string",
                "enum": ["integer", "float", "boolean", "percentage"],
                "default": "integer"
              },
              "expected_value": {
                "oneOf": [
                  { "type": "integer" },
                  { "type": "number" },
                  { "type": "boolean" },
                  { "type": "string" }
                ],
                "description": "Target value for this metric"
              },
              "comparison": {
                "type": "string",
                "enum": ["eq", "lte", "gte", "lt", "gt", "contains", "not_contains"],
                "default": "eq"
              },
              "tolerance": {
                "type": "number",
                "default": 0,
                "minimum": 0,
                "description": "Allowed deviation from expected_value (must be non-negative)"
              },
              "verification_notes": {
                "type": "string",
                "description": "How agents should interpret this metric"
              }
            }
          }
        }
      }
    },
    "baseline": {
      "type": "object",
      "properties": {
        "measured_at": { "type": "string", "format": "date-time" },
        "metrics": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "value": {},
              "command_output": { "type": "string" }
            }
          }
        }
      }
    },
    "target": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["zero", "threshold", "reduction", "existence", "absence", "improvement"]
        },
        "primary_metric": {
          "type": "string",
          "description": "metric_id of the primary success metric"
        },
        "all_metrics_required": {
          "type": "boolean",
          "default": true,
          "description": "All verifiable_metrics must pass for goal to be achieved"
        }
      }
    },
    "multi_perspective": {
      "type": "object",
      "description": "Multi-agent perspective configuration",
      "required": ["discovery_agents", "verification_agents"],
      "properties": {
        "discovery_agents": {
          "type": "array",
          "description": "Agents for Phase 1 discovery (run in parallel)",
          "items": {
            "type": "object",
            "required": ["agent_id", "perspective", "source"],
            "properties": {
              "agent_id": { "type": "string" },
              "perspective": {
                "type": "string",
                "description": "What this agent analyzes"
              },
              "source": {
                "type": "string",
                "enum": ["internal", "codex"],
                "description": "Internal Claude agent or external Codex delegation"
              },
              "codex_expert": {
                "type": "string",
                "enum": ["Architect", "Code Reviewer", "Security Analyst", "Scope Analyst"],
                "description": "For Codex delegations, which expert to use"
              },
              "prompt_template": {
                "type": "string",
                "description": "Path to prompt template for this agent"
              },
              "weight": {
                "type": "number",
                "minimum": 0,
                "maximum": 1,
                "default": 1,
                "description": "Importance weight for consensus"
              }
            }
          }
        },
        "verification_agents": {
          "type": "array",
          "description": "Agents for Phase 4 verification consensus (run in parallel)",
          "items": {
            "type": "object",
            "required": ["agent_id", "perspective", "source", "required_metrics"],
            "properties": {
              "agent_id": { "type": "string" },
              "perspective": { "type": "string" },
              "source": {
                "type": "string",
                "enum": ["internal", "codex"]
              },
              "required_metrics": {
                "type": "array",
                "items": { "type": "string" },
                "description": "metric_ids this agent MUST verify"
              },
              "veto_power": {
                "type": "boolean",
                "default": false,
                "description": "Can this agent block consensus alone?"
              }
            }
          }
        },
        "consensus_threshold": {
          "type": "number",
          "minimum": 0.5,
          "maximum": 1,
          "default": 0.75,
          "description": "Fraction of agents that must approve (e.g., 0.75 = 3/4)"
        }
      }
    },
    "behavioral": {
      "type": "object",
      "description": "Behavioral TDD configuration (enabled by default)",
      "required": ["enabled"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Behavioral TDD is ON by default; use --no-behavioral to disable"
        },
        "personas": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["Brenda", "David", "Dr. Evans", "System"]
          },
          "description": "Which personas are affected by this goal"
        },
        "acceptance_scenarios": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["scenario_id", "given", "when", "then"],
            "properties": {
              "scenario_id": { "type": "string" },
              "persona": { "type": "string" },
              "given": { "type": "string" },
              "when": { "type": "string" },
              "then": { "type": "string" },
              "and": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
          }
        },
        "test_file": {
          "type": "string",
          "description": "Path to behavioral acceptance test file"
        }
      }
    },
    "consensus": {
      "type": "object",
      "description": "Consensus verification configuration (enabled by default)",
      "required": ["enabled"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Consensus verification ON by default; use --no-consensus to disable"
        },
        "required_approvals": {
          "type": "integer",
          "minimum": 1,
          "default": 3,
          "description": "Minimum number of agent approvals needed"
        },
        "veto_agents": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Agent IDs with veto power"
        },
        "verification_results": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "agent_id": { "type": "string" },
              "verdict": {
                "type": "string",
                "enum": ["APPROVE", "REQUEST_CHANGES", "REJECT"]
              },
              "metrics_verified": {
                "type": "object",
                "additionalProperties": {
                  "type": "object",
                  "properties": {
                    "passed": { "type": "boolean" },
                    "actual_value": {},
                    "expected_value": {},
                    "notes": { "type": "string" }
                  }
                }
              },
              "timestamp": { "type": "string", "format": "date-time" },
              "notes": { "type": "string" }
            }
          }
        }
      }
    },
    "complexity": {
      "type": "object",
      "properties": {
        "tier": {
          "type": "integer",
          "enum": [1, 2, 3]
        },
        "reasoning": { "type": "string" },
        "requires_user_approval": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "remediation": {
      "type": "object",
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["replace", "remove", "refactor", "add", "wrap", "custom"]
        },
        "replacement": { "type": "string" },
        "guidance": { "type": "string" },
        "five_whys_required": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "progress": {
      "type": "object",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["pending", "discovery", "behavioral_tdd", "ralph_loop", "verification", "quality_gate", "achieved", "blocked", "deferred", "verified_acceptable"]
        },
        "current_phase": {
          "type": "string",
          "enum": ["init", "discovery", "behavioral", "ralph", "consensus", "quality_gate", "intent_verification", "complete"]
        },
        "iterations": { "type": "integer" },
        "metrics_history": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "iteration": { "type": "integer" },
              "timestamp": { "type": "string", "format": "date-time" },
              "metrics": {
                "type": "object",
                "additionalProperties": {}
              }
            }
          }
        },
        "discovery_results": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "agent_id": { "type": "string" },
              "findings": { "type": "string" },
              "refinements_suggested": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
          }
        }
      }
    },
    "achievement_verification": {
      "type": "object",
      "description": "Tracks HOW a goal was verified as achieved - enables 'trust but re-verify'",
      "properties": {
        "method": {
          "type": "string",
          "enum": ["detection_command", "consensus_verified", "quality_gate_passed", "manual_claim", "auto_converged"],
          "description": "How the achievement was verified"
        },
        "confidence": {
          "type": "string",
          "enum": ["high", "medium", "low"],
          "description": "Confidence level based on verification method"
        },
        "detection_result": {
          "type": "object",
          "properties": {
            "command": { "type": "string" },
            "output": { "type": "string" },
            "expected": { "type": "string" },
            "actual": { "type": "string" }
          }
        },
        "verified_by": {
          "type": "string",
          "description": "Agent or human who verified"
        },
        "verified_at": {
          "type": "string",
          "format": "date-time"
        },
        "git_commit_hash": {
          "type": "string",
          "description": "Commit hash at time of verification - for change detection"
        },
        "affected_files": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files that were part of the fix - for change detection"
        },
        "ttl_days": {
          "type": "integer",
          "default": 30,
          "description": "Days until re-verification is required (based on confidence)"
        },
        "recheck_after": {
          "type": "string",
          "format": "date-time",
          "description": "Computed expiration date for this verification"
        },
        "recheck_on_file_change": {
          "type": "boolean",
          "default": true,
          "description": "Invalidate verification if affected files change"
        },
        "spot_check_history": {
          "type": "array",
          "description": "History of periodic spot-checks",
          "items": {
            "type": "object",
            "properties": {
              "checked_at": { "type": "string", "format": "date-time" },
              "still_valid": { "type": "boolean" },
              "detection_output": { "type": "string" },
              "notes": { "type": "string" }
            }
          }
        }
      }
    },
    "intent_contract": {
      "type": "object",
      "description": "Records user intent and verification criteria for intent alignment",
      "properties": {
        "user_statement": {
          "type": "string",
          "description": "User's verbatim statement of what they want",
          "minLength": 10
        },
        "system_interpretation": {
          "type": "string",
          "description": "System's interpretation of the user's intent",
          "minLength": 10
        },
        "user_confirmed": {
          "type": "boolean",
          "description": "Whether the user confirmed the interpretation"
        },
        "success_criteria": {
          "type": "array",
          "description": "Verification commands that prove delivery",
          "items": {
            "type": "object",
            "required": ["criterion_id", "description", "verification_command", "expected_result"],
            "properties": {
              "criterion_id": { "type": "string" },
              "description": { "type": "string" },
              "verification_command": { "type": "string" },
              "expected_result": { "type": "string" },
              "comparison": {
                "type": "string",
                "enum": ["eq", "contains", "not_contains", "gte", "lte", "gt", "lt"]
              }
            }
          }
        },
        "captured_at": { "type": "string", "format": "date-time" }
      }
    },
    "integrity": {
      "type": "object",
      "description": "Hash chain for end-to-end integrity verification",
      "properties": {
        "chain": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["phase", "hash", "timestamp"],
            "properties": {
              "phase": { "type": "string" },
              "hash": {
                "type": "string",
                "pattern": "^[a-f0-9]{64}$",
                "description": "SHA-256 hash of goal file at this phase"
              },
              "timestamp": { "type": "string", "format": "date-time" }
            }
          }
        },
        "tamper_warnings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "detected_at": { "type": "string", "format": "date-time" },
              "expected_hash": { "type": "string" },
              "actual_hash": { "type": "string" },
              "user_action": {
                "type": "string",
                "enum": ["continued", "aborted"]
              }
            }
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "schema_version": {
          "type": "string",
          "const": "2.0"
        },
        "created_at": { "type": "string", "format": "date-time" },
        "updated_at": { "type": "string", "format": "date-time" },
        "deferred_to": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    }
  }
}
